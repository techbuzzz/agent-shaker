# Multi-stage build: Frontend + Backend в одном контейнере

# Stage 1: Build Frontend (Vue.js)
FROM node:18-alpine AS frontend-builder

WORKDIR /app/web

# Copy frontend dependencies
COPY web/package*.json ./
RUN npm install

# Copy frontend source
COPY web/ ./

# Build frontend
RUN npm run build

# Stage 2: Build Backend (Go)
FROM golang:1.24-alpine AS backend-builder

WORKDIR /app

# Copy go mod files
COPY go.mod go.sum ./
RUN go mod download

# Copy source code
COPY . .

# Build backend
RUN CGO_ENABLED=0 GOOS=linux go build -o /mcp-server ./cmd/server

# Stage 3: Final image with nginx + backend
FROM alpine:latest

WORKDIR /app

# Install nginx and supervisor to run both services
RUN apk add --no-cache nginx supervisor

# Copy backend binary
COPY --from=backend-builder /mcp-server .

# Copy migrations and docs
COPY migrations ./migrations
COPY *.md ./
COPY docs ./docs

# Copy frontend build to nginx html directory
COPY --from=frontend-builder /app/web/dist /usr/share/nginx/html

# Copy nginx config
COPY web/nginx.conf /etc/nginx/http.d/default.conf

# Create supervisor config to run both nginx and backend
RUN mkdir -p /etc/supervisor.d
RUN echo '[supervisord]' > /etc/supervisor.d/supervisord.ini && \
    echo 'nodaemon=true' >> /etc/supervisor.d/supervisord.ini && \
    echo '' >> /etc/supervisor.d/supervisord.ini && \
    echo '[program:backend]' >> /etc/supervisor.d/supervisord.ini && \
    echo 'command=/app/mcp-server' >> /etc/supervisor.d/supervisord.ini && \
    echo 'autostart=true' >> /etc/supervisor.d/supervisord.ini && \
    echo 'autorestart=true' >> /etc/supervisor.d/supervisord.ini && \
    echo 'stdout_logfile=/dev/stdout' >> /etc/supervisor.d/supervisord.ini && \
    echo 'stdout_logfile_maxbytes=0' >> /etc/supervisor.d/supervisord.ini && \
    echo 'stderr_logfile=/dev/stderr' >> /etc/supervisor.d/supervisord.ini && \
    echo 'stderr_logfile_maxbytes=0' >> /etc/supervisor.d/supervisord.ini && \
    echo '' >> /etc/supervisor.d/supervisord.ini && \
    echo '[program:nginx]' >> /etc/supervisor.d/supervisord.ini && \
    echo 'command=nginx -g "daemon off;"' >> /etc/supervisor.d/supervisord.ini && \
    echo 'autostart=true' >> /etc/supervisor.d/supervisord.ini && \
    echo 'autorestart=true' >> /etc/supervisor.d/supervisord.ini && \
    echo 'stdout_logfile=/dev/stdout' >> /etc/supervisor.d/supervisord.ini && \
    echo 'stdout_logfile_maxbytes=0' >> /etc/supervisor.d/supervisord.ini && \
    echo 'stderr_logfile=/dev/stderr' >> /etc/supervisor.d/supervisord.ini && \
    echo 'stderr_logfile_maxbytes=0' >> /etc/supervisor.d/supervisord.ini

EXPOSE 80 8080

CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor.d/supervisord.ini"]
